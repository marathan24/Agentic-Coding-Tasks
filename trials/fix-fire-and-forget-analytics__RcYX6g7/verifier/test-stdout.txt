============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.1, pluggy-1.6.0 -- /root/.cache/uv/archive-v0/mdHudGbn_DMEPWZE7BPi5/bin/python
cachedir: .pytest_cache
rootdir: /tests
plugins: anyio-4.11.0, json-ctrf-0.3.5
collecting ... collected 6 items

../tests/test_performance.py::test_health_endpoint PASSED
../tests/test_performance.py::test_streaming_returns_immediately FAILED
../tests/test_performance.py::test_analytics_eventually_recorded PASSED
../tests/test_performance.py::test_concurrent_requests_no_blocking PASSED
../tests/test_performance.py::test_per_chunk_timing_proves_non_blocking PASSED
../tests/test_performance.py::test_no_data_loss PASSED

=================================== FAILURES ===================================
______________________ test_streaming_returns_immediately ______________________

client = <httpx.Client object at 0xffffad6bdf50>

    def test_streaming_returns_immediately(client):
        start_time = time.time()
    
        response = client.post("/stream", json={"query": "test query", "num_chunks": 10})
    
        assert response.status_code == 200
    
        chunks = []
        for line in response.iter_lines():
            if line.startswith("data:"):
                chunks.append(line)
    
        elapsed_time = time.time() - start_time
    
        assert len(chunks) == 10, f"Expected 10 chunks, got {len(chunks)}"
    
>       assert elapsed_time < 0.2, (
            f"Streaming took {elapsed_time:.3f}s - analytics is still blocking! "
            f"Should be ~0.1s for 10 chunks without blocking."
        )
E       AssertionError: Streaming took 0.378s - analytics is still blocking! Should be ~0.1s for 10 chunks without blocking.
E       assert 0.37776684761047363 < 0.2

/tests/test_performance.py:46: AssertionError
=========================== short test summary info ============================
FAILED ../tests/test_performance.py::test_streaming_returns_immediately - Ass...
========================= 1 failed, 5 passed in 7.74s ==========================
