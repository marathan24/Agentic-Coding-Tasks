============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.1, pluggy-1.6.0 -- /root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/bin/python
cachedir: .pytest_cache
rootdir: /tests
plugins: json-ctrf-0.3.5, anyio-4.11.0
collecting ... collected 3 items

../tests/test_streaming.py::test_health_endpoint PASSED
../tests/test_streaming.py::test_stream_completes_with_eof_marker FAILED
../tests/test_streaming.py::test_all_data_delivered_correctly FAILED

=================================== FAILURES ===================================
____________________ test_stream_completes_with_eof_marker _____________________

    @contextlib.contextmanager
    def map_httpcore_exceptions() -> typing.Iterator[None]:
        try:
>           yield

/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:110: in __iter__
    for part in self._httpcore_stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/connection_pool.py:407: in __iter__
    raise exc from None
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/connection_pool.py:403: in __iter__
    for part in self._stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:342: in __iter__
    raise exc
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:334: in __iter__
    for chunk in self._connection._receive_response_body(**kwargs):
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:203: in _receive_response_body
    event = self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:217: in _receive_event
    data = self._network_stream.read(
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_backends/sync.py:126: in read
    with map_exceptions(exc_map):
/usr/local/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

map = {<class 'TimeoutError'>: <class 'httpcore.ReadTimeout'>, <class 'OSError'>: <class 'httpcore.ReadError'>}

    @contextlib.contextmanager
    def map_exceptions(map: ExceptionMapping) -> typing.Iterator[None]:
        try:
            yield
        except Exception as exc:  # noqa: PIE786
            for from_exc, to_exc in map.items():
                if isinstance(exc, from_exc):
>                   raise to_exc(exc) from exc
E                   httpcore.ReadTimeout: timed out

/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_exceptions.py:14: ReadTimeout

The above exception was the direct cause of the following exception:

client = <httpx.Client object at 0xffff93feec10>

    def test_stream_completes_with_eof_marker(client):
        """
        Test that the stream completes successfully and receives the EOF marker.
    
        This is the key test - it verifies that even with a 35-second processing
        gap, the connection stays alive long enough for the stream to complete
        and deliver all data including the EOF marker.
        """
        received_messages = []
        received_eof = False
    
        start_time = time.time()
    
        with client.stream("GET", "/stream/test_query") as response:
            assert response.status_code == 200
    
>           for line in response.iter_lines():

/tests/test_streaming.py:38: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:862: in iter_lines
    for text in self.iter_text():
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:849: in iter_text
    for byte_content in self.iter_bytes():
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:828: in iter_bytes
    for raw_bytes in self.iter_raw():
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:886: in iter_raw
    for raw_stream_bytes in self.stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_client.py:123: in __iter__
    for chunk in self._stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:109: in __iter__
    with map_httpcore_exceptions():
/usr/local/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @contextlib.contextmanager
    def map_httpcore_exceptions() -> typing.Iterator[None]:
        try:
            yield
        except Exception as exc:
            mapped_exc = None
    
            for from_exc, to_exc in HTTPCORE_EXC_MAP.items():
                if not isinstance(exc, from_exc):
                    continue
                # We want to map to the most specific exception we can find.
                # Eg if `exc` is an `httpcore.ReadTimeout`, we want to map to
                # `httpx.ReadTimeout`, not just `httpx.TimeoutException`.
                if mapped_exc is None or issubclass(to_exc, mapped_exc):
                    mapped_exc = to_exc
    
            if mapped_exc is None:  # pragma: no cover
                raise
    
            message = str(exc)
>           raise mapped_exc(message) from exc
E           httpx.ReadTimeout: timed out

/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:83: ReadTimeout
______________________ test_all_data_delivered_correctly _______________________

    @contextlib.contextmanager
    def map_httpcore_exceptions() -> typing.Iterator[None]:
        try:
>           yield

/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:110: in __iter__
    for part in self._httpcore_stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/connection_pool.py:407: in __iter__
    raise exc from None
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/connection_pool.py:403: in __iter__
    for part in self._stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:342: in __iter__
    raise exc
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:334: in __iter__
    for chunk in self._connection._receive_response_body(**kwargs):
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:203: in _receive_response_body
    event = self._receive_event(timeout=timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_sync/http11.py:217: in _receive_event
    data = self._network_stream.read(
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_backends/sync.py:126: in read
    with map_exceptions(exc_map):
/usr/local/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

map = {<class 'TimeoutError'>: <class 'httpcore.ReadTimeout'>, <class 'OSError'>: <class 'httpcore.ReadError'>}

    @contextlib.contextmanager
    def map_exceptions(map: ExceptionMapping) -> typing.Iterator[None]:
        try:
            yield
        except Exception as exc:  # noqa: PIE786
            for from_exc, to_exc in map.items():
                if isinstance(exc, from_exc):
>                   raise to_exc(exc) from exc
E                   httpcore.ReadTimeout: timed out

/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpcore/_exceptions.py:14: ReadTimeout

The above exception was the direct cause of the following exception:

client = <httpx.Client object at 0xffff929dd7d0>

    def test_all_data_delivered_correctly(client):
        """
        Test that all data is delivered correctly without loss.
    
        This test verifies that the solution doesn't interfere with
        normal data delivery and that all expected content arrives intact.
        """
        data_messages = []
    
        with client.stream("GET", "/stream/data_integrity_test") as response:
            assert response.status_code == 200
    
>           for line in response.iter_lines():

/tests/test_streaming.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:862: in iter_lines
    for text in self.iter_text():
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:849: in iter_text
    for byte_content in self.iter_bytes():
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:828: in iter_bytes
    for raw_bytes in self.iter_raw():
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_models.py:886: in iter_raw
    for raw_stream_bytes in self.stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_client.py:123: in __iter__
    for chunk in self._stream:
/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:109: in __iter__
    with map_httpcore_exceptions():
/usr/local/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @contextlib.contextmanager
    def map_httpcore_exceptions() -> typing.Iterator[None]:
        try:
            yield
        except Exception as exc:
            mapped_exc = None
    
            for from_exc, to_exc in HTTPCORE_EXC_MAP.items():
                if not isinstance(exc, from_exc):
                    continue
                # We want to map to the most specific exception we can find.
                # Eg if `exc` is an `httpcore.ReadTimeout`, we want to map to
                # `httpx.ReadTimeout`, not just `httpx.TimeoutException`.
                if mapped_exc is None or issubclass(to_exc, mapped_exc):
                    mapped_exc = to_exc
    
            if mapped_exc is None:  # pragma: no cover
                raise
    
            message = str(exc)
>           raise mapped_exc(message) from exc
E           httpx.ReadTimeout: timed out

/root/.cache/uv/archive-v0/88tbYjKM3rFifsHj-4U3w/lib/python3.11/site-packages/httpx/_transports/default.py:83: ReadTimeout
=========================== short test summary info ============================
FAILED ../tests/test_streaming.py::test_stream_completes_with_eof_marker - ht...
FAILED ../tests/test_streaming.py::test_all_data_delivered_correctly - httpx....
==================== 2 failed, 1 passed in 62.26s (0:01:02) ====================
