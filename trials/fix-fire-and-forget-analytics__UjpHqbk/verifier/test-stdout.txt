============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.1, pluggy-1.6.0 -- /root/.cache/uv/archive-v0/iKItwj0aaNGiXH5WdedBJ/bin/python
cachedir: .pytest_cache
rootdir: /tests
plugins: anyio-4.11.0, json-ctrf-0.3.5
collecting ... collected 6 items

../tests/test_performance.py::test_health_endpoint PASSED
../tests/test_performance.py::test_streaming_returns_immediately PASSED
../tests/test_performance.py::test_analytics_eventually_recorded PASSED
../tests/test_performance.py::test_concurrent_requests_no_blocking FAILED
../tests/test_performance.py::test_per_chunk_timing_proves_non_blocking PASSED
../tests/test_performance.py::test_no_data_loss PASSED

=================================== FAILURES ===================================
_____________________ test_concurrent_requests_no_blocking _____________________

client = <httpx.Client object at 0xffff84f71e10>

    def test_concurrent_requests_no_blocking(client):
        num_concurrent = 5
        chunks_per_request = 8
    
        start_time = time.time()
    
        import concurrent.futures
    
        def make_request(i):
            response = client.post("/stream", json={"query": f"concurrent {i}", "num_chunks": chunks_per_request})
            request_id = response.headers.get("X-Request-ID")
            chunk_count = sum(1 for line in response.iter_lines() if line.startswith("data:"))
            return request_id, chunk_count
    
        with concurrent.futures.ThreadPoolExecutor(max_workers=num_concurrent) as executor:
            results = list(executor.map(make_request, range(num_concurrent)))
    
        elapsed_time = time.time() - start_time
    
        assert len(results) == num_concurrent
        for request_id, chunk_count in results:
            assert request_id is not None
            assert chunk_count == chunks_per_request
    
        assert elapsed_time < 0.5, (
            f"Concurrent requests took {elapsed_time:.3f}s - should be < 0.5s with fire-and-forget"
        )
    
        time.sleep(2.0)
    
        all_analytics = client.get("/analytics").json()
        expected_total = num_concurrent * chunks_per_request
    
>       assert all_analytics["total_records"] == expected_total, (
            f"Expected {expected_total} analytics records, got {all_analytics['total_records']}"
        )
E       AssertionError: Expected 40 analytics records, got 39
E       assert 39 == 40

/tests/test_performance.py:130: AssertionError
=========================== short test summary info ============================
FAILED ../tests/test_performance.py::test_concurrent_requests_no_blocking - A...
========================= 1 failed, 5 passed in 6.69s ==========================
